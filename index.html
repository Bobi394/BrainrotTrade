<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steal a Brainrot Trade ğŸ’¸</title>
<style>
  body {
    font-family: Arial;
    background: #1b1b2a;
    color: #f5f5f5;
    text-align: center;
  }
  input, button, textarea {
    padding: 8px;
    margin: 5px;
    border-radius: 5px;
    border: none;
  }
  button {
    cursor: pointer;
    background: #4e5efc;
    color: white;
  }
  button:hover {
    background: #6f7bff;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 15px;
    justify-items: center;
    padding: 15px;
    max-width: 900px;
    margin: auto;
  }
  .brainrot {
    background: #2c2c44;
    padding: 10px;
    border-radius: 10px;
    width: 90%;
    text-align: left;
  }
  .outofstock {
    opacity: 0.5;
  }
  img {
    border-radius: 8px;
    display: block;
    margin: 0 auto;
  }
  h1 {
    margin-top: 20px;
  }
  /* ğŸ§  Detail-Popup */
  #popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
  }
  #popup-content {
    background: #2c2c44;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    text-align: center;
  }
  #offers {
    margin-top: 30px;
    background: #2c2c44;
    padding: 15px;
    border-radius: 10px;
    max-width: 600px;
    margin-inline: auto;
  }
</style>
</head>
<body>

<h1>ğŸ’¸ Steal a Brainrot - Trade Center ğŸ’¸</h1>

<div id="user-info"></div>

<div id="auth-box">
  <input type="email" id="email" placeholder="E-Mail">
  <input type="password" id="password" placeholder="Passwort">
  <button id="login-btn">Login</button>
  <button id="logout-btn" style="display:none;">Logout</button>
</div>

<h2>ğŸ§  Unsere Brainrots</h2>
<div id="brainrot-list" class="grid">Lade Brainrots...</div>

<!-- ğŸ§© Detail-Popup -->
<div id="popup">
  <div id="popup-content">
    <h3 id="popup-name"></h3>
    <img id="popup-img" width="150">
    <p><em id="popup-rarity"></em></p>
    <p><strong>Stock:</strong> <span id="popup-stock"></span></p>
    <div id="offer-section">
      <input type="text" id="popup-username" placeholder="Roblox Username"><br>
      <textarea id="popup-offertext" placeholder="Dein Angebot" rows="2" cols="28"></textarea><br>
      <button id="popup-send">ğŸ“© Angebot senden</button>
    </div>
    <button onclick="closePopup()">âŒ SchlieÃŸen</button>
  </div>
</div>

<h2>ğŸ“œ Deine Angebote</h2>
<div id="offers">Bitte anmelden...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSGYr4opBpK_G-U7Vs7o5boniVVojClaU",
  authDomain: "brainrottrade-bada5.firebaseapp.com",
  projectId: "brainrottrade-bada5",
  storageBucket: "brainrottrade-bada5.firebasestorage.app",
  messagingSenderId: "141473188329",
  appId: "1:141473188329:web:3548a50d851d8807bbe378",
  measurementId: "G-TJR1CS3SSP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const brainrotList = document.getElementById("brainrot-list");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const offersDiv = document.getElementById("offers");

// ğŸ” Login / Logout
loginBtn.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    alert("âœ… Login erfolgreich!");
  } catch (err) {
    alert("âŒ " + err.message);
  }
});
logoutBtn.addEventListener("click", async () => { await signOut(auth); });

onAuthStateChanged(auth, (user) => {
  if (user) {
    userInfo.textContent = `ğŸ‘¤ Eingeloggt als: ${user.email}`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    emailInput.style.display = "none";
    passwordInput.style.display = "none";
    ladeBrainrots();
    ladeEigeneAngebote();
  } else {
    userInfo.textContent = "Nicht eingeloggt";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    emailInput.style.display = "inline-block";
    passwordInput.style.display = "inline-block";
    brainrotList.innerHTML = "";
    offersDiv.innerHTML = "Bitte anmelden...";
  }
});

// ğŸ§  Brainrots laden
async function ladeBrainrots() {
  brainrotList.innerHTML = "Lade...";
  const snapshot = await getDocs(collection(db, "brainrots"));
  brainrotList.innerHTML = "";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement("div");
    div.className = "brainrot" + (data.stock === 0 ? " outofstock" : "");
    div.innerHTML = `
      <strong>${data.name}</strong><br>
      <em>Rarity:</em> ${data.rarity || "Unbekannt"}<br>
      <img src="${data.imageUrl || 'https://placehold.co/120x120'}" width="120"><br>
      <button onclick="openPopup('${docSnap.id}','${data.name}','${data.imageUrl}','${data.rarity}','${data.stock ?? 0}')">â„¹ï¸ Details</button>
    `;
    brainrotList.appendChild(div);
  });
}

// ğŸª„ Popup Ã¶ffnen
window.openPopup = function(id,name,img,rarity,stock){
  document.getElementById("popup-name").textContent = name;
  document.getElementById("popup-img").src = img;
  document.getElementById("popup-rarity").textContent = rarity;
  document.getElementById("popup-stock").textContent = stock;
  document.getElementById("popup").style.display = "flex";
  document.getElementById("popup-send").onclick = () => sendOffer(id);
};
window.closePopup = function(){ document.getElementById("popup").style.display = "none"; };

// ğŸ“¤ Angebot senden
async function sendOffer(id) {
  const user = auth.currentUser;
  if (!user) { alert("Bitte zuerst anmelden!"); return; }
  const robloxUsername = document.getElementById("popup-username").value.trim();
  const offerText = document.getElementById("popup-offertext").value.trim();
  if (!robloxUsername || !offerText) { alert("Bitte alles ausfÃ¼llen!"); return; }

  await addDoc(collection(db, "offers"), {
    brainrotId: id,
    robloxUsername,
    offerText,
    fromEmail: user.email,
    status: "pending",
    createdAt: serverTimestamp()
  });

  alert("âœ… Dein Angebot wurde gesendet!");
  closePopup();
  ladeEigeneAngebote();
}

// ğŸ“œ Eigene Angebote laden
async function ladeEigeneAngebote(){
  const user = auth.currentUser;
  if(!user) return;
  offersDiv.innerHTML = "Lade...";
  const q = query(collection(db,"offers"), where("fromEmail","==",user.email));
  const snapshot = await getDocs(q);
  if(snapshot.empty){ offersDiv.innerHTML="Keine Angebote bisher."; return; }

  let html = "";
  snapshot.forEach(docSnap=>{
    const o = docSnap.data();
    let statusIcon = "ğŸ•’";
    if(o.status==="accepted") statusIcon = "âœ…";
    else if(o.status==="rejected") statusIcon = "âŒ";
    html += `
      <div style="border-bottom:1px solid #444; padding:5px;">
        ${statusIcon} <strong>${o.brainrotName || o.brainrotId}</strong><br>
        <em>${o.offerText}</em><br>
        Roblox: ${o.robloxUsername}<br>
        Status: ${o.status || "pending"}
      </div>
    `;
  });
  offersDiv.innerHTML = html;
}
</script>

</body>
</html>
