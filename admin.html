<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steal a Brainrot - Admin ğŸ› ï¸</title>
<style>
body { font-family: Arial; background:#1b1b2a; color:#f5f5f5; text-align:center; }
input, button { padding:8px; margin:5px; border-radius:5px; border:none; }
button { cursor:pointer; background:#4e5efc; color:white; }
button:hover { background:#6f7bff; }
#admin-section { margin-top:40px; background:#2c2c44; padding:15px; border-radius:10px; max-width:800px; margin:auto; text-align:left; }
#offers, #brainrots-list { margin-top:20px; background:#2c2c44; padding:15px; border-radius:10px; max-width:800px; margin:auto; }
.brainrot-admin { border-bottom:1px solid #444; padding:5px; margin-bottom:5px; }
.offer-admin { border-bottom:1px solid #444; padding:5px; margin-bottom:5px; }
input[type=number] { width:80px; }
</style>
</head>
<body>

<h1>ğŸ› ï¸ Steal a Brainrot - Admin Panel ğŸ› ï¸</h1>

<div id="user-info"></div>
<div id="auth-box">
  <input type="email" id="email" placeholder="E-Mail">
  <input type="password" id="password" placeholder="Passwort">
  <button id="login-btn">Login</button>
  <button id="logout-btn" style="display:none;">Logout</button>
</div>

<div id="admin-section" style="display:none;">
  <h2>ğŸ“œ Alle Angebote</h2>
  <div id="offers">Lade...</div>

  <h2>â• Brainrots verwalten</h2>
  <input type="text" id="admin-brainrot-name" placeholder="Name">
  <input type="text" id="admin-brainrot-rarity" placeholder="Rarity">
  <input type="text" id="admin-brainrot-img" placeholder="Bild URL">
  <input type="number" id="admin-brainrot-stock" placeholder="Stock" min="0">
  <button id="admin-add-brainrot">Erstellen</button>

  <h3>ğŸ§  Bestehende Brainrots bearbeiten</h3>
  <div id="brainrots-list">Lade...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = { /* Dein Firebase Config */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userInfo = document.getElementById("user-info");
const adminSection = document.getElementById("admin-section");
const offersDiv = document.getElementById("offers");
const addBrainrotBtn = document.getElementById("admin-add-brainrot");
const brainrotsListDiv = document.getElementById("brainrots-list");

let brainrotCache = {};
let currentUser = null;

// ğŸ” Login
loginBtn.addEventListener("click", async () => {
  try{
    await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
  } catch(err){ alert("âŒ "+err.message); }
});

// ğŸ” Logout
logoutBtn.addEventListener("click", async()=>{ await signOut(auth); });

// Auth State
onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    const token = await user.getIdTokenResult();
    const isAdmin = token.claims.admin === true;
    if(!isAdmin){ alert("âŒ Du bist kein Admin!"); await signOut(auth); return; }
    userInfo.textContent = `ğŸ‘¤ Admin eingeloggt: ${user.email}`;
    loginBtn.style.display="none"; logoutBtn.style.display="inline-block";
    emailInput.style.display="none"; passwordInput.style.display="none";
    adminSection.style.display="block";
    ladeOffers(); ladeBrainrots();
  } else {
    currentUser = null;
    userInfo.textContent="Nicht eingeloggt";
    loginBtn.style.display="inline-block"; logoutBtn.style.display="none";
    emailInput.style.display="inline-block"; passwordInput.style.display="inline-block";
    adminSection.style.display="none";
  }
});

// ======================
// Brainrots Funktionen
// ======================

// Brainrot erstellen
addBrainrotBtn.addEventListener("click", async()=>{
  const name = document.getElementById("admin-brainrot-name").value.trim();
  const rarity = document.getElementById("admin-brainrot-rarity").value.trim();
  const img = document.getElementById("admin-brainrot-img").value.trim();
  const stock = parseInt(document.getElementById("admin-brainrot-stock").value)||0;
  if(!name){ alert("Name fehlt"); return; }
  await addDoc(collection(db,"brainrots"),{name,rarity,imageUrl:img,stock});
  alert("âœ… Brainrot erstellt!");
  ladeBrainrots();
});

// Alle Brainrots laden
async function ladeBrainrots(){
  brainrotsListDiv.innerHTML="Lade...";
  brainrotCache = {};
  const snapshot = await getDocs(collection(db,"brainrots"));
  brainrotsListDiv.innerHTML="";
  snapshot.forEach(docSnap=>{
    const b = docSnap.data();
    brainrotCache[docSnap.id] = b;
    const div = document.createElement("div");
    div.className="brainrot-admin";
    div.innerHTML = `
      <strong>${b.name}</strong> | Rarity: ${b.rarity} | Stock: <input type="number" value="${b.stock}" min="0" id="stock-${docSnap.id}" style="width:60px;">
      <br>Bild URL: <input type="text" value="${b.imageUrl||''}" id="img-${docSnap.id}" style="width:300px;">
      <br><button onclick="updateBrainrot('${docSnap.id}')">ğŸ’¾ Speichern</button>
      <button onclick="deleteBrainrot('${docSnap.id}')">ğŸ—‘ï¸ LÃ¶schen</button>
    `;
    brainrotsListDiv.appendChild(div);
  });
}

// Brainrot bearbeiten
window.updateBrainrot = async (id)=>{
  const stock = parseInt(document.getElementById(`stock-${id}`).value)||0;
  const img = document.getElementById(`img-${id}`).value.trim();
  await updateDoc(doc(db,"brainrots",id),{stock,img});
  alert("âœ… Brainrot aktualisiert!");
  ladeBrainrots();
}

// Brainrot lÃ¶schen
window.deleteBrainrot = async(id)=>{
  if(confirm("Willst du diesen Brainrot wirklich lÃ¶schen?")){
    await deleteDoc(doc(db,"brainrots",id));
    alert("âœ… Brainrot gelÃ¶scht!");
    ladeBrainrots();
  }
}

// ======================
// Offers Funktionen
// ======================

async function ladeOffers(){
  offersDiv.innerHTML="Lade...";
  const snapshot = await getDocs(query(collection(db,"offers"),orderBy("createdAt","desc")));
  offersDiv.innerHTML="";
  if(snapshot.empty){ offersDiv.innerHTML="Keine Angebote."; return; }
  snapshot.forEach(docSnap=>{
    const o = docSnap.data();
    const div = document.createElement("div");
    div.className="offer-admin";
    let icon="ğŸ•’";
    if(o.status==="accepted") icon="âœ…";
    else if(o.status==="rejected") icon="âŒ";
    else if(o.status==="done") icon="ğŸ‰";
    div.innerHTML = `
      ${icon} <strong>${o.brainrotName}</strong> von ${o.fromEmail}<br>
      Roblox: ${o.robloxUsername}<br>
      Angebot: ${o.offerText}<br>
      Status: <select id="status-${docSnap.id}">
        <option value="pending" ${o.status==="pending"?"selected":""}>pending</option>
        <option value="accepted" ${o.status==="accepted"?"selected":""}>accepted</option>
        <option value="rejected" ${o.status==="rejected"?"selected":""}>rejected</option>
        <option value="done" ${o.status==="done"?"selected":""}>done</option>
      </select>
      <br><button onclick="updateOfferStatus('${docSnap.id}')">ğŸ’¾ Speichern</button>
      <button onclick="deleteOffer('${docSnap.id}')">ğŸ—‘ï¸ LÃ¶schen</button>
    `;
    offersDiv.appendChild(div);
  });
}

// Offer Status aktualisieren
window.updateOfferStatus = async(id)=>{
  const status = document.getElementById(`status-${id}`).value;
  await updateDoc(doc(db,"offers",id),{status});
  ladeOffers();
}

// Offer lÃ¶schen
window.deleteOffer = async(id)=>{
  if(confirm("Willst du dieses Angebot lÃ¶schen?")){
    await deleteDoc(doc(db,"offers",id));
    ladeOffers();
  }
}

</script>
</body>
</html>